name: ğŸ¤– Automated Railway Deployment

on:
  push:
    branches: [ prod ]
  pull_request:
    branches: [ prod ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if checks fail'
        required: false
        default: 'false'

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  comprehensive-check:
    name: ğŸ” Comprehensive Project Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v5
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Python dependencies for analysis
      run: |
        pip install --upgrade pip
        pip install ast-grep bandit safety
        
    - name: ğŸ” Analyze Python imports
      run: |
        echo "ğŸ Analyzing Python imports..."
        find realty -name "*.py" -exec grep -H "^from\|^import" {} \; > imports.txt
        echo "Found $(wc -l < imports.txt) import statements"
        
    - name: ğŸ³ Validate Dockerfile
      run: |
        echo "ğŸ³ Validating Dockerfile..."
        if [ -f "Dockerfile.railway" ]; then
          echo "âœ… Railway Dockerfile found"
        else
          echo "âŒ Railway Dockerfile missing"
          exit 1
        fi
        
        if [ -f "apps/DXB-frontend-develop/Dockerfile" ]; then
          echo "âœ… Frontend Dockerfile found"
        else
          echo "âŒ Frontend Dockerfile missing"
          exit 1
        fi
        
    - name: âš™ï¸ Check Django settings
      run: |
        echo "âš™ï¸ Checking Django settings..."
        python -c "
        import re
        with open('realty/settings.py', 'r') as f:
            content = f.read()
            
        # Check for problematic imports
        problematic = ['from falco', 'from realty.pfimport', 'from realty.reports']
        issues = []
        
        for pattern in problematic:
            if re.search(pattern, content) and not re.search(f'#{pattern}', content):
                issues.append(f'Found uncommented: {pattern}')
                
        if issues:
            print('âŒ Django settings issues:')
            for issue in issues:
                print(f'  {issue}')
            exit(1)
        else:
            print('âœ… Django settings look good')
        "
        
    - name: ğŸ“Š Generate report
      run: |
        echo "ğŸ“Š Generating comprehensive report..."
        echo "## ğŸ” Comprehensive Check Report" > check-report.md
        echo "- **Python files analyzed:** $(find realty -name '*.py' | wc -l)" >> check-report.md
        echo "- **Import statements:** $(wc -l < imports.txt)" >> check-report.md
        echo "- **Dockerfile status:** âœ… Valid" >> check-report.md
        echo "- **Django settings:** âœ… Clean" >> check-report.md
        
    - name: ğŸ“¤ Upload report
      uses: actions/upload-artifact@v3
      with:
        name: comprehensive-check-report
        path: check-report.md

  railway-deploy:
    name: ğŸš‚ Railway Deployment
    needs: comprehensive-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/prod' || github.event.inputs.force_deploy == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v5
      
    - name: ğŸš‚ Install Railway CLI
      run: |
        curl -fsSL https://railway.com/install.sh | sh
        echo "$HOME/.railway/bin" >> $GITHUB_PATH
        
    - name: ğŸ” Railway Login
      run: |
        echo "$RAILWAY_TOKEN" | railway login --token
        
    - name: ğŸš€ Deploy to Railway
      run: |
        # Link to existing project or create new one
        if [ -n "$RAILWAY_PROJECT_ID" ]; then
          railway link $RAILWAY_PROJECT_ID
        else
          echo "Creating new Railway project..."
          railway init --name "dubai-mvp-backend"
        fi
        
        # Deploy using the railway.json configuration
        railway up
        
    - name: â³ Wait for deployment
      run: |
        echo "â³ Waiting for deployment to complete..."
        sleep 120
        
    - name: ğŸ¥ Health check
      run: |
        echo "ğŸ¥ Checking backend health..."
        max_attempts=10
        attempt=1
        
        # Get the deployment URL from Railway
        DEPLOYMENT_URL=$(railway status --json | jq -r '.services[0].url // empty')
        
        if [ -z "$DEPLOYMENT_URL" ]; then
          echo "âŒ Could not get deployment URL"
          exit 1
        fi
        
        echo "Testing health at: $DEPLOYMENT_URL/health/"
        
        while [ $attempt -le $max_attempts ]; do
          echo "Attempt $attempt/$max_attempts..."
          
          if curl -f -s "$DEPLOYMENT_URL/health/" > /dev/null; then
            echo "âœ… Backend is healthy!"
            curl -s "$DEPLOYMENT_URL/health/" | jq .
            break
          else
            echo "âŒ Backend not responding, waiting..."
            sleep 30
            attempt=$((attempt + 1))
          fi
        done
        
        if [ $attempt -gt $max_attempts ]; then
          echo "âŒ Backend health check failed after $max_attempts attempts"
          exit 1
        fi

  integration-test:
    name: ğŸ§ª Integration Testing
    needs: railway-deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v5
      
    - name: ğŸš‚ Install Railway CLI
      run: |
        curl -fsSL https://railway.com/install.sh | sh
        echo "$HOME/.railway/bin" >> $GITHUB_PATH
        
    - name: ğŸ” Railway Login
      run: |
        echo "$RAILWAY_TOKEN" | railway login --token
        
    - name: ğŸ§ª Test API endpoints
      run: |
        echo "ğŸ§ª Testing API endpoints..."
        
        # Get the deployment URL
        railway link
        DEPLOYMENT_URL=$(railway status --json | jq -r '.services[0].url // empty')
        
        if [ -z "$DEPLOYMENT_URL" ]; then
          echo "âŒ Could not get deployment URL"
          exit 1
        fi
        
        echo "Testing API at: $DEPLOYMENT_URL"
        
        # Test health endpoint
        if curl -f -s "$DEPLOYMENT_URL/health/" > /dev/null; then
          echo "âœ… Health endpoint working"
        else
          echo "âŒ Health endpoint failed"
          exit 1
        fi
        
        # Test admin endpoint
        if curl -f -s "$DEPLOYMENT_URL/admin/" > /dev/null; then
          echo "âœ… Admin endpoint accessible"
        else
          echo "âŒ Admin endpoint failed"
          exit 1
        fi
        
    - name: ğŸ“Š Final report
      run: |
        echo "ğŸ“Š Integration test completed successfully!"
        echo "ğŸ‰ Deployment is ready for production use!"
        echo ""
        echo "ğŸ”— Backend API: $DEPLOYMENT_URL"
        echo "ğŸ”— Health Check: $DEPLOYMENT_URL/health/"
        echo "ğŸ”— Admin Panel: $DEPLOYMENT_URL/admin/"
