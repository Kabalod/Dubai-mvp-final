name: 🤖 Automated Railway Deployment

on:
  push:
    branches: [ prod ]
  pull_request:
    branches: [ prod ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if checks fail'
        required: false
        default: 'false'

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  comprehensive-check:
    name: 🔍 Comprehensive Project Check
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 📦 Install Python dependencies for analysis
      run: |
        pip install --upgrade pip
        pip install ast-grep bandit safety
        
    - name: 🔍 Analyze Python imports
      run: |
        echo "🐍 Analyzing Python imports..."
        find apps/realty-main -name "*.py" -exec grep -H "^from\|^import" {} \; > imports.txt
        echo "Found $(wc -l < imports.txt) import statements"
        
    - name: 🐳 Validate Dockerfile
      run: |
        echo "🐳 Validating Dockerfile..."
        if [ -f "apps/realty-main/Dockerfile" ]; then
          echo "✅ Backend Dockerfile found"
        else
          echo "❌ Backend Dockerfile missing"
          exit 1
        fi
        
        if [ -f "apps/DXB-frontend-develop/Dockerfile" ]; then
          echo "✅ Frontend Dockerfile found"
        else
          echo "❌ Frontend Dockerfile missing"
          exit 1
        fi
        
    - name: ⚙️ Check Django settings
      run: |
        echo "⚙️ Checking Django settings..."
        python -c "
        import re
        with open('apps/realty-main/realty/settings.py', 'r') as f:
            content = f.read()
            
        # Check for problematic imports
        problematic = ['from falco', 'from realty.pfimport', 'from realty.reports']
        issues = []
        
        for pattern in problematic:
            if re.search(pattern, content) and not re.search(f'#{pattern}', content):
                issues.append(f'Found uncommented: {pattern}')
                
        if issues:
            print('❌ Django settings issues:')
            for issue in issues:
                print(f'  {issue}')
            exit(1)
        else:
            print('✅ Django settings look good')
        "
        
    - name: 📊 Generate report
      run: |
        echo "📊 Generating comprehensive report..."
        echo "## 🔍 Comprehensive Check Report" > check-report.md
        echo "- **Python files analyzed:** $(find apps/realty-main -name '*.py' | wc -l)" >> check-report.md
        echo "- **Import statements:** $(wc -l < imports.txt)" >> check-report.md
        echo "- **Dockerfile status:** ✅ Valid" >> check-report.md
        echo "- **Django settings:** ✅ Clean" >> check-report.md
        
    - name: 📤 Upload report
      uses: actions/upload-artifact@v3
      with:
        name: comprehensive-check-report
        path: check-report.md

  railway-deploy:
    name: 🚂 Railway Deployment
    needs: comprehensive-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/prod' || github.event.inputs.force_deploy == 'true'
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🚂 Install Railway CLI
      run: |
        curl -fsSL https://railway.com/install.sh | sh
        echo "$HOME/.railway/bin" >> $GITHUB_PATH
        
    - name: 🔐 Railway Login
      run: |
        echo "$RAILWAY_TOKEN" | railway login --token
        
    - name: 🚀 Deploy to Railway
      run: |
        railway link ccd447ca-39b8-444a-b8d1-28ac1ec894a8
        railway up --service workerproject-production
        
    - name: ⏳ Wait for deployment
      run: |
        echo "⏳ Waiting for deployment to complete..."
        sleep 120
        
    - name: 🏥 Health check
      run: |
        echo "🏥 Checking backend health..."
        max_attempts=10
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          echo "Attempt $attempt/$max_attempts..."
          
          if curl -f -s "https://workerproject-production.up.railway.app/api/health/" > /dev/null; then
            echo "✅ Backend is healthy!"
            curl -s "https://workerproject-production.up.railway.app/api/health/" | jq .
            break
          else
            echo "❌ Backend not responding, waiting..."
            sleep 30
            attempt=$((attempt + 1))
          fi
        done
        
        if [ $attempt -gt $max_attempts ]; then
          echo "❌ Backend health check failed after $max_attempts attempts"
          exit 1
        fi

  integration-test:
    name: 🧪 Integration Testing
    needs: railway-deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: 🧪 Test OTP endpoints
      run: |
        echo "🧪 Testing OTP endpoints..."
        
        # Test send-otp endpoint
        echo "Testing send-otp endpoint..."
        response=$(curl -s -w "%{http_code}" -X POST \
          "https://workerproject-production.up.railway.app/api/auth/send-otp/" \
          -H "Content-Type: application/json" \
          -d '{"email": "test@example.com"}')
        
        http_code="${response: -3}"
        if [ "$http_code" = "200" ] || [ "$http_code" = "400" ]; then
          echo "✅ Send OTP endpoint responding"
        else
          echo "❌ Send OTP endpoint failed with code: $http_code"
          exit 1
        fi
        
    - name: 🌐 Test frontend
      run: |
        echo "🌐 Testing frontend..."
        if curl -f -s "https://frontend-production-5c48.up.railway.app/" > /dev/null; then
          echo "✅ Frontend is accessible"
        else
          echo "❌ Frontend is not accessible"
          exit 1
        fi
        
    - name: 📊 Final report
      run: |
        echo "📊 Integration test completed successfully!"
        echo "🎉 Deployment is ready for production use!"
        echo ""
        echo "🔗 Links:"
        echo "  Backend API: https://workerproject-production.up.railway.app/api/health/"
        echo "  Frontend: https://frontend-production-5c48.up.railway.app/"
        echo "  OTP Test: https://frontend-production-5c48.up.railway.app/auth"
        echo ""
        echo "📧 To test OTP:"
        echo "  1. Go to frontend auth page"
        echo "  2. Enter email: kbalodk@gmail.com"
        echo "  3. Click SIGN UP"
        echo "  4. Check email for OTP code"
