name: ğŸ¤– Automated Railway Deployment

on:
  push:
    branches: [ prod ]
  pull_request:
    branches: [ prod ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if checks fail'
        required: false
        default: 'false'

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  comprehensive-check:
    name: ğŸ” Comprehensive Project Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Python dependencies for analysis
      run: |
        pip install --upgrade pip
        pip install ast-grep bandit safety
        
    - name: ğŸ” Analyze Python imports
      run: |
        echo "ğŸ Analyzing Python imports..."
        find apps/realty-main -name "*.py" -exec grep -H "^from\|^import" {} \; > imports.txt
        echo "Found $(wc -l < imports.txt) import statements"
        
    - name: ğŸ³ Validate Dockerfile
      run: |
        echo "ğŸ³ Validating Dockerfile..."
        if [ -f "apps/realty-main/Dockerfile" ]; then
          echo "âœ… Backend Dockerfile found"
        else
          echo "âŒ Backend Dockerfile missing"
          exit 1
        fi
        
        if [ -f "apps/DXB-frontend-develop/Dockerfile" ]; then
          echo "âœ… Frontend Dockerfile found"
        else
          echo "âŒ Frontend Dockerfile missing"
          exit 1
        fi
        
    - name: âš™ï¸ Check Django settings
      run: |
        echo "âš™ï¸ Checking Django settings..."
        python -c "
        import re
        with open('apps/realty-main/realty/settings.py', 'r') as f:
            content = f.read()
            
        # Check for problematic imports
        problematic = ['from falco', 'from realty.pfimport', 'from realty.reports']
        issues = []
        
        for pattern in problematic:
            if re.search(pattern, content) and not re.search(f'#{pattern}', content):
                issues.append(f'Found uncommented: {pattern}')
                
        if issues:
            print('âŒ Django settings issues:')
            for issue in issues:
                print(f'  {issue}')
            exit(1)
        else:
            print('âœ… Django settings look good')
        "
        
    - name: ğŸ“Š Generate report
      run: |
        echo "ğŸ“Š Generating comprehensive report..."
        echo "## ğŸ” Comprehensive Check Report" > check-report.md
        echo "- **Python files analyzed:** $(find apps/realty-main -name '*.py' | wc -l)" >> check-report.md
        echo "- **Import statements:** $(wc -l < imports.txt)" >> check-report.md
        echo "- **Dockerfile status:** âœ… Valid" >> check-report.md
        echo "- **Django settings:** âœ… Clean" >> check-report.md
        
    - name: ğŸ“¤ Upload report
      uses: actions/upload-artifact@v3
      with:
        name: comprehensive-check-report
        path: check-report.md

  railway-deploy:
    name: ğŸš‚ Railway Deployment
    needs: comprehensive-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/prod' || github.event.inputs.force_deploy == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš‚ Install Railway CLI
      run: |
        curl -fsSL https://railway.com/install.sh | sh
        echo "$HOME/.railway/bin" >> $GITHUB_PATH
        
    - name: ğŸ” Railway Login
      run: |
        echo "$RAILWAY_TOKEN" | railway login --token
        
    - name: ğŸš€ Deploy to Railway
      run: |
        railway link ccd447ca-39b8-444a-b8d1-28ac1ec894a8
        railway up --service workerproject-production
        
    - name: â³ Wait for deployment
      run: |
        echo "â³ Waiting for deployment to complete..."
        sleep 120
        
    - name: ğŸ¥ Health check
      run: |
        echo "ğŸ¥ Checking backend health..."
        max_attempts=10
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          echo "Attempt $attempt/$max_attempts..."
          
          if curl -f -s "https://workerproject-production.up.railway.app/api/health/" > /dev/null; then
            echo "âœ… Backend is healthy!"
            curl -s "https://workerproject-production.up.railway.app/api/health/" | jq .
            break
          else
            echo "âŒ Backend not responding, waiting..."
            sleep 30
            attempt=$((attempt + 1))
          fi
        done
        
        if [ $attempt -gt $max_attempts ]; then
          echo "âŒ Backend health check failed after $max_attempts attempts"
          exit 1
        fi

  integration-test:
    name: ğŸ§ª Integration Testing
    needs: railway-deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ§ª Test OTP endpoints
      run: |
        echo "ğŸ§ª Testing OTP endpoints..."
        
        # Test send-otp endpoint
        echo "Testing send-otp endpoint..."
        response=$(curl -s -w "%{http_code}" -X POST \
          "https://workerproject-production.up.railway.app/api/auth/send-otp/" \
          -H "Content-Type: application/json" \
          -d '{"email": "test@example.com"}')
        
        http_code="${response: -3}"
        if [ "$http_code" = "200" ] || [ "$http_code" = "400" ]; then
          echo "âœ… Send OTP endpoint responding"
        else
          echo "âŒ Send OTP endpoint failed with code: $http_code"
          exit 1
        fi
        
    - name: ğŸŒ Test frontend
      run: |
        echo "ğŸŒ Testing frontend..."
        if curl -f -s "https://frontend-production-5c48.up.railway.app/" > /dev/null; then
          echo "âœ… Frontend is accessible"
        else
          echo "âŒ Frontend is not accessible"
          exit 1
        fi
        
    - name: ğŸ“Š Final report
      run: |
        echo "ğŸ“Š Integration test completed successfully!"
        echo "ğŸ‰ Deployment is ready for production use!"
        echo ""
        echo "ğŸ”— Links:"
        echo "  Backend API: https://workerproject-production.up.railway.app/api/health/"
        echo "  Frontend: https://frontend-production-5c48.up.railway.app/"
        echo "  OTP Test: https://frontend-production-5c48.up.railway.app/auth"
        echo ""
        echo "ğŸ“§ To test OTP:"
        echo "  1. Go to frontend auth page"
        echo "  2. Enter email: kbalodk@gmail.com"
        echo "  3. Click SIGN UP"
        echo "  4. Check email for OTP code"
