# üî• Railway Frontend Dockerfile - –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø v0.1.4
# –û–¥–Ω–æ—ç—Ç–∞–ø–Ω–∞—è —Å–±–æ—Ä–∫–∞ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º –º–µ–∂–¥—É stages
# Apollo Client –ü–û–õ–ù–û–°–¢–¨–Æ –£–î–ê–õ–ï–ù - —Ç–æ–ª—å–∫–æ REST API
# –ó–ê–ú–ï–ù–ï–ù nginx –Ω–∞ Caddy –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã

FROM node:20-bullseye-slim

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
ENV CACHE_BUST=2025-09-01-02-40
ENV NODE_ENV=production
ENV APOLLO_REMOVED=true
ENV BACKEND_URL=http://backend:8000

# –ú–µ—Ç–∫–∏ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
LABEL cache-bust="2025-01-29-19-30"
LABEL apollo-removed="true"
LABEL caddy-replaced-nginx="true"
LABEL version="0.1.4"
LABEL single-stage="true"

# –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN apt-get update && apt-get install -y \
    git \
    python3 \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
COPY package.json ./
COPY lingui.config.js postcss.config.js tailwind.config.js tsconfig.json vite.config.ts ./

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤–∫–ª—é—á–∞—è devDependencies –¥–ª—è —Å–±–æ—Ä–∫–∏
RUN npm install --include=dev --legacy-peer-deps --no-fund --no-audit

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
COPY src/ ./src/
COPY public/ ./public/
COPY index.html ./

# –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–æ–≤—ã–π bundle –±–µ–∑ Apollo)  
RUN npm run build

# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ
RUN ls -la /app/dist/ && cat /app/dist/index.html

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Caddy
RUN apt-get update && apt-get install -y curl && \
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg && \
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list && \
    apt-get update && apt-get install -y caddy && \
    rm -rf /var/lib/apt/lists/*

# –°–æ–∑–¥–∞–Ω–∏–µ Caddyfile –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è BACKEND_URL)
RUN echo '# üöÄ Caddy Configuration for Dubai MVP Frontend' > /etc/caddy/Caddyfile && \
    echo '# –ü—Ä–æ—Å—Ç–∞—è –∏ –Ω–∞–¥–µ–∂–Ω–∞—è –∑–∞–º–µ–Ω–∞ nginx' >> /etc/caddy/Caddyfile && \
    echo '' >> /etc/caddy/Caddyfile && \
    echo ':80 {' >> /etc/caddy/Caddyfile && \
    echo '    # Router: —Å–Ω–∞—á–∞–ª–∞ API, –ø–æ—Ç–æ–º SPA' >> /etc/caddy/Caddyfile && \
    echo '    route {' >> /etc/caddy/Caddyfile && \
    echo '        # API ‚Üí backend (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å, –Ω–µ –æ–±—Ä–µ–∑–∞–µ–º /api)' >> /etc/caddy/Caddyfile && \
    echo '        handle /api/* {' >> /etc/caddy/Caddyfile && \
    echo '            reverse_proxy {$BACKEND_URL} {' >> /etc/caddy/Caddyfile && \
    echo '                header_up Host {upstream_hostport}' >> /etc/caddy/Caddyfile && \
    echo '                header_up X-Real-IP {remote_host}' >> /etc/caddy/Caddyfile && \
    echo '                header_up X-Forwarded-For {remote_host}' >> /etc/caddy/Caddyfile && \
    echo '                header_up X-Forwarded-Proto {scheme}' >> /etc/caddy/Caddyfile && \
    echo '                transport http {' >> /etc/caddy/Caddyfile && \
    echo '                    tls_insecure_skip_verify' >> /etc/caddy/Caddyfile && \
    echo '                }' >> /etc/caddy/Caddyfile && \
    echo '            }' >> /etc/caddy/Caddyfile && \
    echo '        }' >> /etc/caddy/Caddyfile && \
    echo '        # SPA —Å—Ç–∞—Ç–∏–∫–∞' >> /etc/caddy/Caddyfile && \
    echo '        handle {' >> /etc/caddy/Caddyfile && \
    echo '            root * /app/dist' >> /etc/caddy/Caddyfile && \
    echo '            try_files {path} /index.html' >> /etc/caddy/Caddyfile && \
    echo '            file_server' >> /etc/caddy/Caddyfile && \
    echo '            @static {' >> /etc/caddy/Caddyfile && \
    echo '                file' >> /etc/caddy/Caddyfile && \
    echo '                path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot' >> /etc/caddy/Caddyfile && \
    echo '            }' >> /etc/caddy/Caddyfile && \
    echo '            header @static Cache-Control "public, max-age=31536000, immutable"' >> /etc/caddy/Caddyfile && \
    echo '        }' >> /etc/caddy/Caddyfile && \
    echo '    }' >> /etc/caddy/Caddyfile && \
    echo '    # Health check endpoint' >> /etc/caddy/Caddyfile && \
    echo '    respond /health "healthy" 200' >> /etc/caddy/Caddyfile && \
    echo '}' >> /etc/caddy/Caddyfile

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤
RUN chown -R 1000:1000 /app && \
    chmod -R 755 /app

# –ü–æ—Ä—Ç
EXPOSE 80

# –ó–∞–ø—É—Å–∫ Caddy (—è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è Railway)
CMD ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--adapter", "caddyfile"]

# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞)
# CMD ["sh", "-c", "echo 'Starting Caddy...' && caddy run --config /etc/caddy/Caddyfile --adapter caddyfile"]