{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-8 px-6 mx-auto">

  {# ---------------- Форма выбора Building/Bedrooms ---------------- #}
  <form id="brForm" class="flex flex-wrap gap-4 items-end mb-10">
    <div class="w-full sm:w-1/2 lg:w-1/3">
      <label class="block text-sm font-medium text-gray-700">Здание</label>
      <select id="building" class="block mt-1 w-full rounded-md border-gray-300 shadow-sm">
        <option value="" disabled selected>— выберите здание —</option>
        {% for b in buildings %}<option value="{{ b.pk }}">{{ b.name }}</option>{% endfor %}
      </select>
    </div>
    <div class="w-full sm:w-1/3 lg:w-1/5">
      <label class="block text-sm font-medium text-gray-700">Комнатность</label>
      <select id="bedrooms" class="block mt-1 w-full rounded-md border-gray-300 shadow-sm">
        <option value="" disabled selected>— выберите —</option>
        {% for k,l in bedroom_choices %}<option value="{{ k }}">{{ l }}</option>{% endfor %}
      </select>
    </div>
    <button type="submit"
            class="py-2 px-6 text-white bg-indigo-600 rounded-md hover:bg-indigo-700">
      Just report
    </button>
  </form>

  <div id="reportArea"></div>
</div>

<script>
const qs = s => document.querySelector(s);
const percent = (a,b)=> b&&b!==0 ? ((a-b)/b*100).toFixed(2)+'%' : '—';

/* безопасное fetch-обёртывание */
async function fetchJSON(url){
  const r = await fetch(url, {headers:{'X-Requested-With':'fetch'}});
  if(!r.ok) throw new Error(await r.text() || r.status);
  const ct = r.headers.get('content-type')||'';
  if(!ct.includes('application/json')) throw new Error('Non-JSON response');
  return r.json();
}

/* ---------- рендер красивой таблицы Продажа/Аренда ---------- */
function renderMainTables(data){
  const b = data.building_report,
        a = data.area_report,
        c = data.city_report;
  const BR = k=>b?.[k]??'—', AR=k=>a?.[k]??'—', CR=k=>c?.[k]??'—';

  const saleRows = [
    ['Средняя цена'             ,'avg_sale_price'            ,'avg_sale_price'            ,'avg_price'],
    ['Средняя по зданию'        ,'avg_sale_price'            ,'avg_sale_price_by_building','avg_price_by_building'],
    ['Медиана'                  ,'median_sale_price'         ,'median_sale_price'         ,'median_price'],
    ['Разброс цен'              ,()=>`${b.min_sale_price} – ${b.max_sale_price}`,
                                   ()=>`${a.min_sale_price} – ${a.max_rent_price}`,
                                   ()=>`${c.min_price} – ${c.max_price}`],
    ['Кол-во объявлений'        ,'sale_count'                ,()=>'—',                    ()=>'—'],
    ['Средняя экспозиция'       ,'avg_exposure_sale_days'    ,'avg_exposure_sale_days'    ,'avg_exposure_days'],
    ['Удельная частота продаж'  ,'sale_per_unit_ratio'       ,'avg_exposure_sale_days'    ,'avg_sale_per_unit_ratio'],
    ['ROI'                      ,'roi'                       ,'avg_roi'                   ,'avg_roi'],
  ];

  const rentRows = [
    ['Средняя цена аренды'      ,'avg_rent_price'            ,'avg_rent_price'            ,'avg_rent_price'],
    ['Средняя по зданию'        ,'avg_rent_price'            ,'avg_rent_price_by_building','avg_rent_price_by_building'],
    ['Медиана аренды'           ,'median_rent_price'         ,'median_rent_price'         ,'median_rent_price'],
    ['Разброс цен аренды'       ,()=>`${b.min_rent_price} – ${b.max_rent_price}`,
                                   ()=>`${a.min_sale_price} – ${a.max_rent_price}`,
                                   ()=>`${c.min_rent_price} – ${c.max_rent_price}`],
    ['Кол-во объявлений аренды' ,'rent_count'                ,()=>'—',                    ()=>'—'],
    ['Средняя экспозиция аренды','avg_exposure_rent_days'    ,'avg_exposure_rent_days'    ,'avg_exposure_rent_days'],
    ['ROI аренды'               ,'roi'                       ,'avg_roi'                   ,'avg_roi'],
  ];

  const rowHTML = rows => rows.map(r=>{
    const [label,bk,ak,ck] = r;
    const td = v => `<td class="py-2 px-4">${typeof v==='function'?v():v}</td>`;
    return `<tr>
      <td class="py-2 px-4">${label}</td>
      ${td(typeof bk==='string'?BR(bk):bk)}
      ${td(typeof ak==='string'?AR(ak):ak)}
      ${td(typeof ck==='string'?CR(ck):ck)}
    </tr>`
  }).join('');

  return `
  <div class="mb-8">
    <h1 class="text-4xl font-bold text-gray-800">${a.area?.name || ''}</h1>
    <h2 class="text-3xl font-semibold text-gray-700">${data.building.name} / ${data.bedrooms}BR</h2>
  </div>

  <section class="mb-12">
    <h3 class="mb-4 text-2xl font-semibold">Продажа</h3>
    <table class="w-full text-left border-collapse table-auto">
      <thead><tr class="bg-gray-100">
        <th class="py-2 px-4">Метрика</th><th class="py-2 px-4">BuildingReport</th>
        <th class="py-2 px-4">AreaReport</th><th class="py-2 px-4">CityReport</th></tr></thead>
      <tbody class="divide-y">${rowHTML(saleRows)}</tbody>
    </table>
  </section>

  <section class="mb-12">
    <h3 class="mb-4 text-2xl font-semibold">Аренда</h3>
    <table class="w-full text-left border-collapse table-auto">
      <thead><tr class="bg-gray-100">
        <th class="py-2 px-4">Метрика</th><th class="py-2 px-4">BuildingReport</th>
        <th class="py-2 px-4">AreaReport</th><th class="py-2 px-4">CityReport</th></tr></thead>
      <tbody class="divide-y">${rowHTML(rentRows)}</tbody>
    </table>
  </section>`;
}

/* ---------- рендер DLD box-table ---------- */
function renderDldRows(rows){
  const group2 = rows.reduce((acc,r,i)=>(acc[Math.floor(i/2)].push(r),acc),
                             Array.from({length:Math.ceil(rows.length/2)},()=>[]));
  return group2.map(g=>`
    <tbody class="rounded-lg border border-gray-300">
      ${g.map(r=>`
       <tr class="bg-white">
         <td class="p-2">${r.label}</td>
         <td class="p-2">${r.current??'—'}</td>
         <td class="p-2 text-purple-600">${r.change??'—'}</td>
         <td class="p-2 text-blue-600">${r.yellow_dist??'—'}</td>
         <td class="p-2 text-purple-600">${r.change_dist??'—'}</td>
         <td class="p-2 text-blue-600">${r.yellow_dub??'—'}</td>
         <td class="p-2 text-purple-600">${r.change_dub??'—'}</td>
         <td class="p-2"></td>
       </tr>`).join('')}
    </tbody>`).join('');
}

function renderDldTable(d){
  const sale   = renderDldRows(d.sale_rows);
  const rent   = renderDldRows(d.rent_rows);
  const last3s = (d.last_3_sales||[]).map(t=>`${t.date} — ${t.price} AED / ${t.sqm} м²`).join('<br>')||'—';
  const last3r = (d.last_3_rents||[]).map(t=>`${t.date} — ${t.price} AED / ${t.sqm} м²`).join('<br>')||'—';

  return `
  <div class="overflow-x-auto">
   <table class="min-w-full text-sm border-separate table-fixed border-spacing-y-4">
     <thead><tr class="bg-gray-50">
       <th class="p-2 w-1/4"></th><th class="p-2 w-1/6">Building</th><th class="p-2 w-1/12">Δ</th>
       <th class="p-2 w-1/6">District</th><th class="p-2 w-1/12">Δ</th>
       <th class="p-2 w-1/6">Dubai</th><th class="p-2 w-1/12">Δ</th><th class="p-2 w-1/6"></th>
     </tr></thead>

     <tbody class="bg-blue-50 rounded-lg border border-gray-300"><tr>
       <td class="p-2 font-semibold">DLD Продажа</td><td colspan="7"></td></tr></tbody>
     ${sale}

     <tbody class="rounded-lg border border-gray-300"><tr>
       <td class="p-2"></td><td class="p-2" colspan="7">
         <span class="font-semibold text-red-600">3 последние сделки (продажа):</span><br>${last3s}
       </td></tr></tbody>

     <tbody class="bg-blue-50 rounded-lg border border-gray-300"><tr>
       <td class="p-2 font-semibold">DLD Аренда</td><td colspan="7"></td></tr></tbody>
     ${rent}

     <tbody class="rounded-lg border border-gray-300"><tr>
       <td class="p-2"></td><td class="p-2" colspan="7">
         <span class="font-semibold text-red-600">3 последние сделки (аренда):</span><br>${last3r}
       </td></tr></tbody>
   </table>
  </div>`;
}

/* ------------- submit ------------- */
qs('#brForm').addEventListener('submit', async ev=>{
  ev.preventDefault();
  const building  = qs('#building').value;
  const bedrooms  = qs('#bedrooms').value;
  if(!building || !bedrooms) return;

  try{
    const aggr    = await fetchJSON(`/r2d2/api/aggregated/?building=${building}&bedrooms=${bedrooms}`);
    aggr.building = aggr.building||{};
    aggr.bedrooms = bedrooms;

    const dldRows = await fetchJSON(`/r2d2/api/dldbuilding_rows/?building=${building}&bedrooms=${bedrooms}`);

    qs('#reportArea').innerHTML = `
      ${renderMainTables(aggr)}
      <section class="my-12"><h3 class="mb-4 text-2xl font-semibold">DLD Building Report (годовое изменение)</h3>
        ${renderDldTable(dldRows)}
      </section>`;
  }catch(e){
    qs('#reportArea').innerHTML = `<p class="text-red-600">Ошибка: ${e.message}</p>`;
    console.error(e);
  }
});
</script>
{% endblock content %}
